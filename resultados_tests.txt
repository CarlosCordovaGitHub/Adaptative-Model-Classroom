============================= test session starts =============================
platform win32 -- Python 3.13.2, pytest-9.0.2, pluggy-1.6.0 -- C:\Users\carlo\AppData\Local\Programs\Python\Python313\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\carlo\Documents\GitHub\Adaptative-Model-Classroom
plugins: anyio-4.9.0, locust-2.42.6, cov-7.0.0
collecting ... collected 7 items

test_validation.py::test_theta_convergence 
[SETUP] Limpieza: Carpeta 'runtime' eliminada.

================================================================================
TEST 1: CONVERGENCIA DE THETA
================================================================================
FAILED
test_validation.py::test_se_reduction 
================================================================================
TEST 2: REDUCCIÓN DE SE
================================================================================

SE inicial: 0.9305
SE final: 0.6744
Reducción total: 0.2562
Monotonicidad: 100.0%
FAILED
test_validation.py::test_efficiency 
================================================================================
TEST 3: EFICIENCIA
================================================================================
Estudiante sim_student_001: 9 ítems para SE <= 0.4
Estudiante sim_student_002: 8 ítems para SE <= 0.4
Estudiante sim_student_003: 7 ítems para SE <= 0.4
Estudiante sim_student_004: 7 ítems para SE <= 0.4
Estudiante sim_student_005: 7 ítems para SE <= 0.4
Estudiante sim_student_006: 4 ítems para SE <= 0.4
Estudiante sim_student_007: 3 ítems para SE <= 0.4
Estudiante sim_student_008: 5 ítems para SE <= 0.4
Estudiante sim_student_009: 3 ítems para SE <= 0.4
Estudiante sim_student_010: 7 ítems para SE <= 0.4

Ítems promedio: 6.0
% con <= 15 ítems: 100.0%
FAILED
test_validation.py::test_fairness_across_levels 
================================================================================
TEST 4: EQUIDAD
================================================================================
Grupo bajo: RMSE=0.378
Grupo medio: RMSE=0.482
Grupo alto: RMSE=0.507

Variación RMSE: 34.2%
Peor RMSE: 0.507
FAILED
test_validation.py::test_prediction_quality 
================================================================================
TEST 5: CALIDAD PREDICTIVA
================================================================================

Brier Score: 0.077 (baseline aleatorio: 0.25)
FAILED
test_validation.py::test_stopping_rules 
================================================================================
TEST 6: STOPPING RULES
================================================================================
Razón de parada: ALL_SKILLS_MASTERED:min=0.947,items=5
FAILED
test_validation.py::test_replay_determinism 
================================================================================
TEST 7: REPLAY DETERMINISTA
================================================================================
Original: 1.2815 | Replay: 1.2815
FAILED

================================== FAILURES ===================================
___________________________ test_theta_convergence ____________________________

engine = <app.engine.Engine object at 0x000001F533575FD0>

    def test_theta_convergence(engine):
        print("\n" + "="*80)
        print("TEST 1: CONVERGENCIA DE THETA")
        print("="*80)
    
        theta_values = [-2.0, -1.5, -1.0, -0.5, 0.0, 0.5, 1.0, 1.5, 2.0]
        errors = []
    
        for i, true_theta in enumerate(theta_values):
            profile = StudentProfile(
                student_id=f"test_conv_{true_theta}",
                true_theta=true_theta,
                true_mastery={
                    "k_regla_potencia": max(0.1, min(0.9, (true_theta + 2)/4)),
                    "k_regla_cadena": max(0.1, min(0.9, (true_theta + 2)/4 - 0.1))
                },
                response_consistency=0.9
            )
    
            simulator = StudentSimulator(profile, seed=100 + i)
            results = simulate_full_session(simulator, engine, max_items=20)
    
            final_theta = results["final_state"]["theta"]["theta_hat"]
            error = abs(final_theta - true_theta)
            errors.append(error)
    
>           print(f"\u03b8 real: {true_theta:5.2f} | \u03b8\u0302 final: {final_theta:5.2f} | Error: {error:.3f}")

test_validation.py:80: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <encodings.cp1252.IncrementalEncoder object at 0x000001F52FCB4AD0>
input = '\u03b8 real: -2.00 | \u03b8\u0302 final: -1.65 | Error: 0.346', final = False

    def encode(self, input, final=False):
>       return codecs.charmap_encode(input,self.errors,encoding_table)[0]
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       UnicodeEncodeError: 'charmap' codec can't encode character '\u03b8' in position 0: character maps to <undefined>

..\..\..\AppData\Local\Programs\Python\Python313\Lib\encodings\cp1252.py:19: UnicodeEncodeError
______________________________ test_se_reduction ______________________________

engine = <app.engine.Engine object at 0x000001F533988F50>

    def test_se_reduction(engine):
        print("\n" + "="*80)
        print("TEST 2: REDUCCIÓN DE SE")
        print("="*80)
    
        profile = StudentProfile(
            student_id="test_se",
            true_theta=0.5,
            true_mastery={"k_regla_potencia": 0.6, "k_regla_cadena": 0.4},
            response_consistency=0.95
        )
    
        simulator = StudentSimulator(profile, seed=42)
        results = simulate_full_session(simulator, engine, max_items=20)
    
        se_history = [h["se_theta"] for h in results["convergence_history"]]
    
        if len(se_history) < 2:
            print(f"\\n\u26a0 Sesi\xf3n muy eficiente ({len(se_history)} \xedtem).")
            assert se_history[-1] < 1.0, "SE no disminuyó del valor inicial"
            print("\u2713 Test PASADO (Por eficiencia extrema)")
            return
    
        non_decreasing_count = 0
        for i in range(1, len(se_history)):
            if se_history[i] > se_history[i-1]:
                non_decreasing_count += 1
    
        denominator = max(1, len(se_history) - 1)
        monotonicity_pct = ((denominator - non_decreasing_count) / denominator) * 100
    
        print(f"\nSE inicial: {se_history[0]:.4f}")
        print(f"SE final: {se_history[-1]:.4f}")
        print(f"Reducción total: {se_history[0] - se_history[-1]:.4f}")
        print(f"Monotonicidad: {monotonicity_pct:.1f}%")
    
        assert se_history[-1] < se_history[0], "SE no disminuyó globalmente"
        assert monotonicity_pct >= 85, f"Monotonicidad {monotonicity_pct:.1f}% < 85%"
    
>       print("\u2713 Test de reducci\xf3n SE PASADO")

test_validation.py:142: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <encodings.cp1252.IncrementalEncoder object at 0x000001F52FCB4AD0>
input = '\u2713 Test de reducci\xf3n SE PASADO', final = False

    def encode(self, input, final=False):
>       return codecs.charmap_encode(input,self.errors,encoding_table)[0]
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       UnicodeEncodeError: 'charmap' codec can't encode character '\u2713' in position 0: character maps to <undefined>

..\..\..\AppData\Local\Programs\Python\Python313\Lib\encodings\cp1252.py:19: UnicodeEncodeError
_______________________________ test_efficiency _______________________________

engine = <app.engine.Engine object at 0x000001F533989590>

    def test_efficiency(engine):
        print("\n" + "="*80)
        print("TEST 3: EFICIENCIA")
        print("="*80)
    
        profiles = create_student_profiles(n_students=10)
        items_to_target = []
    
        for i, profile in enumerate(profiles):
            simulator = StudentSimulator(profile, seed=200 + i)
            results = simulate_full_session(simulator, engine, max_items=20)
    
            items_needed = len(results["convergence_history"])
            for idx, h in enumerate(results["convergence_history"]):
                if h["se_theta"] <= 0.4:
                    items_needed = idx + 1
                    break
    
            items_to_target.append(items_needed)
            print(f"Estudiante {profile.student_id}: {items_needed} ítems para SE <= 0.4")
    
        mean_items = statistics.mean(items_to_target)
        pct_under_15 = (sum(1 for n in items_to_target if n <= 15) / len(items_to_target)) * 100
    
        print(f"\nÍtems promedio: {mean_items:.1f}")
        print(f"% con <= 15 ítems: {pct_under_15:.1f}%")
    
        assert mean_items <= 16, f"Promedio {mean_items:.1f} > 16 ítems"
        assert pct_under_15 >= 70, f"Solo {pct_under_15:.1f}% en <= 15 ítems"
    
>       print("\u2713 Test de eficiencia PASADO")

test_validation.py:179: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <encodings.cp1252.IncrementalEncoder object at 0x000001F52FCB4AD0>
input = '\u2713 Test de eficiencia PASADO', final = False

    def encode(self, input, final=False):
>       return codecs.charmap_encode(input,self.errors,encoding_table)[0]
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       UnicodeEncodeError: 'charmap' codec can't encode character '\u2713' in position 0: character maps to <undefined>

..\..\..\AppData\Local\Programs\Python\Python313\Lib\encodings\cp1252.py:19: UnicodeEncodeError
_________________________ test_fairness_across_levels _________________________

engine = <app.engine.Engine object at 0x000001F5339A09D0>

    def test_fairness_across_levels(engine):
        print("\n" + "="*80)
        print("TEST 4: EQUIDAD")
        print("="*80)
    
        groups = {
            "bajo": [StudentProfile(f"low_{i}", -1.5 + i*0.2, {}, 0.85) for i in range(3)],
            "medio": [StudentProfile(f"mid_{i}", -0.2 + i*0.2, {}, 0.9) for i in range(3)],
            "alto": [StudentProfile(f"high_{i}", 1.2 + i*0.2, {}, 0.9) for i in range(3)]
        }
    
        results_by_group = {}
        seed_counter = 500
    
        for group_name, profiles in groups.items():
            errors = []
            for profile in profiles:
                simulator = StudentSimulator(profile, seed=seed_counter)
                seed_counter += 1
                results = simulate_full_session(simulator, engine, max_items=20)
                errors.append(abs(results["final_state"]["theta"]["theta_hat"] - profile.true_theta))
    
            rmse = math.sqrt(sum(e**2 for e in errors) / len(errors))
            results_by_group[group_name] = {"rmse": rmse}
            print(f"Grupo {group_name}: RMSE={rmse:.3f}")
    
        rmse_values = [r["rmse"] for r in results_by_group.values()]
        rmse_min = min(rmse_values)
        rmse_max = max(rmse_values)
    
        if rmse_min < 0.05:
            rmse_variation = 0.0
        else:
            rmse_variation = (rmse_max - rmse_min) / rmse_min
    
        print(f"\nVariación RMSE: {rmse_variation*100:.1f}%")
        print(f"Peor RMSE: {rmse_max:.3f}")
    
        passed_by_sufficiency = rmse_max < 0.70
    
        if passed_by_sufficiency:
>           print("\u2713 Pasa por criterio de suficiencia (Error m\xe1ximo bajo en todos los grupos)")

test_validation.py:227: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <encodings.cp1252.IncrementalEncoder object at 0x000001F52FCB4AD0>
input = '\u2713 Pasa por criterio de suficiencia (Error m\xe1ximo bajo en todos los grupos)'
final = False

    def encode(self, input, final=False):
>       return codecs.charmap_encode(input,self.errors,encoding_table)[0]
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       UnicodeEncodeError: 'charmap' codec can't encode character '\u2713' in position 0: character maps to <undefined>

..\..\..\AppData\Local\Programs\Python\Python313\Lib\encodings\cp1252.py:19: UnicodeEncodeError
___________________________ test_prediction_quality ___________________________

engine = <app.engine.Engine object at 0x000001F5339A1350>

    def test_prediction_quality(engine):
        print("\n" + "="*80)
        print("TEST 5: CALIDAD PREDICTIVA")
        print("="*80)
    
        profile = StudentProfile(
            student_id="test_pred",
            true_theta=0.3,
            true_mastery={"k_regla_potencia": 0.65, "k_regla_cadena": 0.45},
            response_consistency=0.95
        )
    
        simulator = StudentSimulator(profile, seed=42)
        results = simulate_full_session(simulator, engine, max_items=20)
    
        # Calcular Brier score manualmente con los datos que SÍ tenemos
        predictions = []
        actuals = []
    
        for item_result in results["items_administered"]:
            theta = item_result["theta_hat"]
    
            item = engine.items_by_id.get(item_result["item_id"])
            if not item or not item.get("irt"):
                continue
    
            irt = item["irt"]
            a, b, c = float(irt["a"]), float(irt["b"]), float(irt["c"])
    
            # Protección matemática
            try:
                z = a * (theta - b)
                logistic = 1.0 / (1.0 + math.exp(-z))
            except OverflowError:
                logistic = 1.0 if (a * (theta - b)) > 0 else 0.0
    
            p_correct = c + (1.0 - c) * logistic
    
            predictions.append(p_correct)
            actuals.append(1.0 if item_result["is_correct"] else 0.0)
    
        if not predictions:
            print("\u26a0 No hay datos suficientes para Brier Score")
            return
    
        brier_score = sum((p - a)**2 for p, a in zip(predictions, actuals)) / len(predictions)
    
        print(f"\nBrier Score: {brier_score:.3f} (baseline aleatorio: 0.25)")
    
        assert brier_score < 0.30, f"Brier score {brier_score:.3f} >= 0.30"
    
>       print("\u2713 Test de calidad predictiva PASADO")

test_validation.py:289: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <encodings.cp1252.IncrementalEncoder object at 0x000001F52FCB4AD0>
input = '\u2713 Test de calidad predictiva PASADO', final = False

    def encode(self, input, final=False):
>       return codecs.charmap_encode(input,self.errors,encoding_table)[0]
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       UnicodeEncodeError: 'charmap' codec can't encode character '\u2713' in position 0: character maps to <undefined>

..\..\..\AppData\Local\Programs\Python\Python313\Lib\encodings\cp1252.py:19: UnicodeEncodeError
_____________________________ test_stopping_rules _____________________________

engine = <app.engine.Engine object at 0x000001F533971EB0>

    def test_stopping_rules(engine):
        print("\n" + "="*80)
        print("TEST 6: STOPPING RULES")
        print("="*80)
        profile = StudentProfile("test_stop", 1.5, {}, 0.95)
        simulator = StudentSimulator(profile, seed=101)
        results = simulate_full_session(simulator, engine, max_items=20)
        assert "stopped_by" in results
        print(f"Razón de parada: {results.get('stopped_by')}")
>       print("\u2713 Test de stopping rules PASADO")

test_validation.py:305: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <encodings.cp1252.IncrementalEncoder object at 0x000001F52FCB4AD0>
input = '\u2713 Test de stopping rules PASADO', final = False

    def encode(self, input, final=False):
>       return codecs.charmap_encode(input,self.errors,encoding_table)[0]
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       UnicodeEncodeError: 'charmap' codec can't encode character '\u2713' in position 0: character maps to <undefined>

..\..\..\AppData\Local\Programs\Python\Python313\Lib\encodings\cp1252.py:19: UnicodeEncodeError
___________________________ test_replay_determinism ___________________________

engine = <app.engine.Engine object at 0x000001F533957680>

    def test_replay_determinism(engine):
        print("\n" + "="*80)
        print("TEST 7: REPLAY DETERMINISTA")
        print("="*80)
        profile = StudentProfile("test_replay", 0.5, {}, 0.9)
        simulator = StudentSimulator(profile, seed=12345)
        res1 = simulate_full_session(simulator, engine, max_items=5)
        res2 = engine.replay_session(res1["student_id"], res1["session_id"])
    
        theta1 = res1["final_state"]["theta"]["theta_hat"]
        theta2 = res2["final_state"]["theta"]["theta_hat"]
    
        assert abs(theta1 - theta2) < 1e-6, "Fallo en determinismo"
        print(f"Original: {theta1:.4f} | Replay: {theta2:.4f}")
>       print("\u2713 Test de determinismo PASADO")

test_validation.py:321: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <encodings.cp1252.IncrementalEncoder object at 0x000001F52FCB4AD0>
input = '\u2713 Test de determinismo PASADO', final = False

    def encode(self, input, final=False):
>       return codecs.charmap_encode(input,self.errors,encoding_table)[0]
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       UnicodeEncodeError: 'charmap' codec can't encode character '\u2713' in position 0: character maps to <undefined>

..\..\..\AppData\Local\Programs\Python\Python313\Lib\encodings\cp1252.py:19: UnicodeEncodeError
=========================== short test summary info ===========================
FAILED test_validation.py::test_theta_convergence - UnicodeEncodeError: 'char...
FAILED test_validation.py::test_se_reduction - UnicodeEncodeError: 'charmap' ...
FAILED test_validation.py::test_efficiency - UnicodeEncodeError: 'charmap' co...
FAILED test_validation.py::test_fairness_across_levels - UnicodeEncodeError: ...
FAILED test_validation.py::test_prediction_quality - UnicodeEncodeError: 'cha...
FAILED test_validation.py::test_stopping_rules - UnicodeEncodeError: 'charmap...
FAILED test_validation.py::test_replay_determinism - UnicodeEncodeError: 'cha...
============================== 7 failed in 4.25s ==============================
